<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insight Vault</title>
  <style>
    :root {
      --bg: #0b0f17;
      --panel: #111827;
      --panel2: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --brand: #a78bfa;
      --brand2: #60a5fa;
      --border: #243042;
      --danger: #fb7185;
      --ok: #34d399;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 10% -10%, rgba(167,139,250,.22), transparent 60%),
                  radial-gradient(1200px 600px at 90% -10%, rgba(96,165,250,.18), transparent 60%),
                  var(--bg);
      color: var(--text);
    }
    a { color: inherit; }
    .wrap { max-width: 1100px; margin: 28px auto; padding: 0 18px 40px; }
    header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 16px; margin-bottom: 18px;
    }
    .title h1 { margin: 0; font-size: 28px; letter-spacing: .2px; }
    .title p { margin: 6px 0 0; color: var(--muted); font-size: 14px; }
    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      border: 1px solid var(--border);
      background: rgba(17,24,39,.7);
      padding: 10px 12px; border-radius: 999px;
      box-shadow: var(--shadow);
      color: var(--muted);
      font-size: 13px;
    }
    .pill code { font-family: var(--mono); color: var(--text); font-size: 12px; }
    .controls {
      display: grid;
      grid-template-columns: 1.2fr .8fr auto auto;
      gap: 10px;
      margin: 14px 0 18px;
    }
    .input, .select, button {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(17,24,39,.75);
      color: var(--text);
      padding: 11px 12px;
      outline: none;
    }
    .input::placeholder { color: rgba(156,163,175,.7); }
    .select { cursor: pointer; }
    button {
      cursor: pointer;
      transition: transform .06s ease, border-color .2s ease;
      font-weight: 600;
    }
    button:hover { border-color: rgba(167,139,250,.65); }
    button:active { transform: scale(.99); }
    .primary {
      background: linear-gradient(90deg, rgba(167,139,250,.22), rgba(96,165,250,.18));
      border-color: rgba(167,139,250,.5);
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 14px;
      align-items: start;
    }
    .card {
      background: linear-gradient(180deg, rgba(17,24,39,.82), rgba(15,23,42,.72));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card header {
      padding: 14px 14px 10px;
      margin: 0;
      border-bottom: 1px solid rgba(36,48,66,.7);
      display: flex; align-items: center; justify-content: space-between;
    }
    .card header h2 { margin: 0; font-size: 15px; color: rgba(229,231,235,.92); }
    .card header .meta { color: var(--muted); font-size: 12px; }
    .list { padding: 10px; max-height: 62vh; overflow: auto; }
    .item {
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: rgba(15,23,42,.35);
      margin-bottom: 8px;
      cursor: pointer;
      transition: border-color .2s ease, background .2s ease, transform .06s ease;
    }
    .item:hover {
      border-color: rgba(167,139,250,.55);
      background: rgba(17,24,39,.65);
    }
    .item:active { transform: scale(.995); }
    .item .top { display: flex; align-items: baseline; justify-content: space-between; gap: 10px; }
    .item .id { font-family: var(--mono); font-size: 12px; color: rgba(229,231,235,.88); }
    .item .name { font-size: 13px; color: rgba(229,231,235,.92); margin-top: 6px; line-height: 1.25; }
    .badge {
      font-size: 11px; color: rgba(229,231,235,.85);
      border: 1px solid rgba(36,48,66,.9);
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(11,15,23,.35);
      white-space: nowrap;
    }
    .breadcrumbs {
      display: flex; flex-wrap: wrap; gap: 8px;
      color: var(--muted);
      font-size: 12px;
      padding: 12px 14px 0;
    }
    .crumb { cursor: pointer; }
    .crumb:hover { color: rgba(229,231,235,.9); }
    .status {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(36,48,66,.9);
      background: rgba(17,24,39,.55);
      color: var(--muted);
      font-size: 13px;
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .status strong { color: rgba(229,231,235,.92); }
    .status .ok { color: var(--ok); }
    .status .err { color: var(--danger); }
    .small { font-size: 12px; color: var(--muted); }
    .right { text-align: right; }
    .mono { font-family: var(--mono); }
    .empty { color: rgba(156,163,175,.8); padding: 12px; }
    @media (max-width: 980px) {
      .controls { grid-template-columns: 1fr 1fr; }
      .grid { grid-template-columns: 1fr; }
      .list { max-height: none; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Insight Vault</h1>
        <p>Pillars → Topics → Items (bilingual). Static frontend calling your Render backend.</p>
      </div>
      <div class="pill">
        API: <code id="apiBase"></code>
      </div>
    </header>

    <div class="controls">
      <input id="search" class="input" placeholder="Search (id or name)..." />
      <select id="lang" class="select">
        <option value="bilingual">Bilingual</option>
        <option value="en">English only</option>
        <option value="pt">Português</option>
      </select>
      <button id="refresh" class="primary">Refresh</button>
      <button id="health">Health</button>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <div class="breadcrumbs" id="breadcrumbs"></div>
      <div class="status" id="status">
        <div>
          <strong>Status:</strong> <span id="statusText">Loading…</span>
          <div class="small" id="statusHint"></div>
        </div>
        <div class="right small">
          <div>Mode: <span class="mono" id="mode">pillars</span></div>
          <div>Selected: <span class="mono" id="selected">—</span></div>
        </div>
      </div>
      <div style="padding: 0 14px 14px;">
        <div class="small">Tip: click a Pillar → see Topics. Click a Topic → see Items. Click breadcrumb to go back.</div>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <header>
          <h2>Pillars</h2>
          <div class="meta" id="pillarsCount">—</div>
        </header>
        <div class="list" id="pillarsList"></div>
      </section>

      <section class="card">
        <header>
          <h2>Topics</h2>
          <div class="meta" id="topicsCount">—</div>
        </header>
        <div class="list" id="topicsList">
          <div class="empty">Select a pillar.</div>
        </div>
      </section>

      <section class="card">
        <header>
          <h2>Items</h2>
          <div class="meta" id="itemsCount">—</div>
        </header>
        <div class="list" id="itemsList">
          <div class="empty">Select a topic.</div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // const API_BASE = 'https://insight-vault-1.onrender.com;

    // Expected endpoints:
    // GET  /health
    // GET  /pillars
    // GET  /pillars/:pillarId/topics
    // GET  /topics/:topicId/items

    const el = (id) => document.getElementById(id);

    const state = {
      mode: 'pillars',
      lang: 'bilingual',
      search: '',
      pillars: [],
      topics: [],
      items: [],
      selectedPillar: null,
      selectedTopic: null,
    };

    function nameFor(obj, kind) {
      // kind: 'pillar' | 'topic' | 'item'
      const en = obj.name_en ?? obj.title_en ?? obj.en ?? obj.name ?? '';
      const pt = obj.name_pt ?? obj.title_pt ?? obj.pt ?? obj.nome ?? '';
      const id = obj.id ?? obj.code ?? obj.slug ?? '';

      if (state.lang === 'en') return en || pt || id;
      if (state.lang === 'pt') return pt || en || id;
      // bilingual
      if (en && pt) return `${en} / ${pt}`;
      return en || pt || id;
    }

    function setStatus(ok, text, hint = '') {
      el('statusText').textContent = text;
      el('statusText').className = ok ? 'ok' : 'err';
      el('statusHint').textContent = hint;
      el('mode').textContent = state.mode;
      el('selected').textContent = state.selectedTopic?.id || state.selectedPillar?.id || '—';
    }

    function setBreadcrumbs() {
      const bc = el('breadcrumbs');
      bc.innerHTML = '';

      const home = document.createElement('span');
      home.textContent = 'All Pillars';
      home.className = 'crumb';
      home.onclick = () => {
        state.selectedPillar = null;
        state.selectedTopic = null;
        state.topics = [];
        state.items = [];
        state.mode = 'pillars';
        renderAll();
      };
      bc.appendChild(home);

      if (state.selectedPillar) {
        const sep1 = document.createElement('span');
        sep1.textContent = '›';
        bc.appendChild(sep1);

        const p = document.createElement('span');
        p.textContent = `${state.selectedPillar.id}`;
        p.className = 'crumb';
        p.onclick = () => {
          state.selectedTopic = null;
          state.items = [];
          state.mode = 'topics';
          renderAll();
        };
        bc.appendChild(p);
      }

      if (state.selectedTopic) {
        const sep2 = document.createElement('span');
        sep2.textContent = '›';
        bc.appendChild(sep2);

        const t = document.createElement('span');
        t.textContent = `${state.selectedTopic.id}`;
        t.className = 'crumb';
        t.onclick = () => {
          // stay at items
        };
        bc.appendChild(t);
      }
    }

    async function apiGet(path) {
      const url = `${API_BASE}${path}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) {
        const txt = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status} on ${path} ${txt ? `— ${txt.slice(0, 200)}` : ''}`);
      }
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const txt = await res.text().catch(() => '');
        throw new Error(`Expected JSON from ${path}, got: ${ct}. Body: ${txt.slice(0, 200)}`);
      }
      return res.json();
    }

    function filterList(arr) {
      const q = (state.search || '').trim().toLowerCase();
      if (!q) return arr;
      return arr.filter(o => {
        const id = String(o.id ?? '').toLowerCase();
        const n = nameFor(o).toLowerCase();
        return id.includes(q) || n.includes(q);
      });
    }

    function renderList(containerId, arr, onClick, selectedId) {
      const box = el(containerId);
      box.innerHTML = '';

      const filtered = filterList(arr);
      if (!filtered.length) {
        const div = document.createElement('div');
        div.className = 'empty';
        div.textContent = state.search ? 'No results for your search.' : 'Empty.';
        box.appendChild(div);
        return;
      }

      filtered.forEach(o => {
        const div = document.createElement('div');
        div.className = 'item';

        const top = document.createElement('div');
        top.className = 'top';

        const left = document.createElement('div');
        left.className = 'id';
        left.textContent = o.id ?? '—';

        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = (o.count != null) ? `${o.count}` : 'open';

        top.appendChild(left);
        top.appendChild(badge);

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = nameFor(o);

        if ((o.id ?? null) === selectedId) {
          div.style.borderColor = 'rgba(96,165,250,.55)';
          div.style.background = 'rgba(17,24,39,.78)';
        }

        div.appendChild(top);
        div.appendChild(name);
        div.onclick = () => onClick(o);

        box.appendChild(div);
      });
    }

    function renderAll() {
      el('apiBase').textContent = API_BASE;
      setBreadcrumbs();

      const pillarsFiltered = filterList(state.pillars);
      el('pillarsCount').textContent = `${pillarsFiltered.length}/${state.pillars.length}`;

      renderList('pillarsList', state.pillars, (p) => selectPillar(p), state.selectedPillar?.id);

      if (!state.selectedPillar) {
        el('topicsCount').textContent = '—';
        el('topicsList').innerHTML = '<div class="empty">Select a pillar.</div>';
      } else {
        const topicsFiltered = filterList(state.topics);
        el('topicsCount').textContent = `${topicsFiltered.length}/${state.topics.length}`;
        renderList('topicsList', state.topics, (t) => selectTopic(t), state.selectedTopic?.id);
      }

      if (!state.selectedTopic) {
        el('itemsCount').textContent = '—';
        el('itemsList').innerHTML = '<div class="empty">Select a topic.</div>';
      } else {
        const itemsFiltered = filterList(state.items);
        el('itemsCount').textContent = `${itemsFiltered.length}/${state.items.length}`;
        renderList('itemsList', state.items, (it) => {}, null);
      }
    }

    async function loadPillars() {
      state.mode = 'pillars';
      setStatus(true, 'Loading pillars…');
      try {
        const data = await apiGet('/pillars');
        // normalize: must be array of {id, name_en, name_pt}
        state.pillars = Array.isArray(data) ? data : (data.items || []);
        setStatus(true, 'Pillars loaded.', `Found ${state.pillars.length}.`);
        renderAll();
      } catch (e) {
        setStatus(false, 'Failed to load pillars.', e.message);
        console.error(e);
      }
    }

    async function selectPillar(pillar) {
      state.selectedPillar = pillar;
      state.selectedTopic = null;
      state.items = [];
      state.mode = 'topics';
      setStatus(true, `Loading topics for ${pillar.id}…`);
      renderAll();

      try {
        const data = await apiGet(`/pillars/${encodeURIComponent(pillar.id)}/topics`);
        state.topics = Array.isArray(data) ? data : (data.items || []);
        setStatus(true, 'Topics loaded.', `Pillar ${pillar.id}: ${state.topics.length} topics.`);
        renderAll();
      } catch (e) {
        state.topics = [];
        setStatus(false, `Failed to load topics for ${pillar.id}.`, e.message);
        renderAll();
        console.error(e);
      }
    }

    async function selectTopic(topic) {
      state.selectedTopic = topic;
      state.mode = 'items';
      setStatus(true, `Loading items for ${topic.id}…`);
      renderAll();

      try {
        const data = await apiGet(`/topics/${encodeURIComponent(topic.id)}/items`);
        state.items = Array.isArray(data) ? data : (data.items || []);
        setStatus(true, 'Items loaded.', `Topic ${topic.id}: ${state.items.length} items.`);
        renderAll();
      } catch (e) {
        state.items = [];
        setStatus(false, `Failed to load items for ${topic.id}.`, e.message);
        renderAll();
        console.error(e);
      }
    }

    async function healthCheck() {
      setStatus(true, 'Checking /health…');
      try {
        const data = await apiGet('/health');
        setStatus(true, 'Backend OK.', JSON.stringify(data));
      } catch (e) {
        setStatus(false, 'Backend health check failed.', e.message);
      }
    }

    // Wire controls
    el('refresh').onclick = () => loadPillars();
    el('health').onclick = () => healthCheck();
    el('lang').onchange = (ev) => { state.lang = ev.target.value; renderAll(); };
    el('search').oninput = (ev) => { state.search = ev.target.value; renderAll(); };

    // Auto-load
    (async function init() {
      el('apiBase').textContent = API_BASE;
      await loadPillars();
    })();
  </script>
</body>
</html>
