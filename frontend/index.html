<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Insight Vault</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2e; --panel2:#0b1628; --text:#e9eefc; --muted:#a9b4d0;
      --accent:#7c5cff; --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:radial-gradient(1200px 700px at 20% 10%, #1a2a52 0%, var(--bg) 60%); color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:28px 22px 40px;}
    h1{margin:0 0 6px;font-size:44px;letter-spacing:.2px}
    .sub{color:var(--muted);margin:0 0 22px;font-size:16px}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:14px 0 18px;}
    input, select, button{border:1px solid var(--border);background:rgba(15,26,46,.65);color:var(--text);padding:12px 12px;border-radius:12px;font-size:14px;outline:none}
    input{flex:1;min-width:260px}
    select{min-width:180px}
    button{cursor:pointer;background:linear-gradient(180deg, rgba(124,92,255,.28), rgba(124,92,255,.12));}
    button:hover{border-color:rgba(124,92,255,.45)}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-top:14px}
    .card{background:rgba(15,26,46,.55);border:1px solid var(--border);border-radius:18px;padding:14px;backdrop-filter: blur(6px);}
    .card h3{margin:0 0 10px;font-size:16px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    .list{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto;padding-right:4px}
    .item{border:1px solid var(--border);border-radius:14px;padding:10px 10px;background:rgba(11,22,40,.55);cursor:pointer}
    .item:hover{border-color:rgba(124,92,255,.35)}
    .title{font-weight:700;margin:0 0 4px}
    .meta{font-size:12px;color:var(--muted)}
    .body{margin-top:10px;white-space:pre-wrap;line-height:1.35;color:#dfe6ff}
    .status{margin-top:10px;border:1px solid var(--border);border-radius:14px;padding:10px;background:rgba(15,26,46,.35);color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .crumb{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .crumb a{color:#cfd7ff;text-decoration:none;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:rgba(11,22,40,.55)}
    .crumb a:hover{border-color:rgba(124,92,255,.45)}
    .right{display:flex;gap:10px;align-items:center}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Insight Vault</h1>
    <p class="sub">Pillars → Topics → Items (bilingual). Static frontend calling your Render backend.</p>

    <div class="bar">
      <input id="q" placeholder="Search (id or name)..." />
      <select id="lang">
        <option value="bi">Bilingual</option>
        <option value="en">English</option>
        <option value="pt">Português</option>
      </select>
      <div class="right">
        <button id="refreshBtn">Refresh</button>
        <button id="healthBtn">Health</button>
      </div>
    </div>

    <div class="status">
      <div class="row">
        <div><strong>Status:</strong> <span id="statusText">Idle</span></div>
        <div class="meta" id="modeText">Mode: pillars • Selected: —</div>
      </div>
      <div class="crumb" id="crumb"></div>
      <div class="meta" style="margin-top:8px">
        Tip: click a Pillar → see Topics. Click a Topic → see Items. Click breadcrumb to go back.
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Pillars <span class="pill" id="pillarsCount">—</span></h3>
        <div class="list" id="pillars"></div>
      </div>

      <div class="card">
        <h3>Topics <span class="pill" id="topicsCount">—</span></h3>
        <div class="list" id="topics"><div class="meta">Select a pillar.</div></div>
      </div>

      <div class="card">
        <h3>Items <span class="pill" id="itemsCount">—</span></h3>
        <div class="list" id="items"><div class="meta">Select a topic.</div></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h3>Item Preview <span class="pill" id="previewId">—</span></h3>
      <div class="body" id="previewBody" style="color:var(--muted)">Select an item.</div>
    </div>
  </div>

  <script>
    // ✅ SEU BACKEND:
    const API_BASE = "https://insight-vault-58jj.onrender.com";

    const el = (id) => document.getElementById(id);
    const state = {
      pillars: [],
      topics: [],
      items: [],
      selectedPillar: null,
      selectedTopic: null,
      selectedItem: null,
      mode: "pillars"
    };

    function label(obj, kind){
      const lang = el("lang").value;
      if(kind === "pillar") return formatName(obj.id, obj.name_en, obj.name_pt, lang);
      if(kind === "topic")  return formatName(obj.id, obj.name_en, obj.name_pt, lang);
      if(kind === "item")   return formatName(obj.id, obj.title_en, obj.title_pt, lang);
      return "";
    }

    function formatName(id, en, pt, lang){
      if(lang === "en") return `${id} — ${en}`;
      if(lang === "pt") return `${id} — ${pt}`;
      return `${id} — ${en} / ${pt}`;
    }

    function setStatus(msg, mode){
      el("statusText").textContent = msg;
      if(mode) state.mode = mode;
      el("modeText").textContent = `Mode: ${state.mode} • Selected: ${state.selectedPillar || "—"} ${state.selectedTopic ? "› " + state.selectedTopic : ""} ${state.selectedItem ? "› " + state.selectedItem : ""}`;
      renderCrumb();
    }

    function renderCrumb(){
      const c = el("crumb");
      c.innerHTML = "";
      const mk = (text, fn) => {
        const a = document.createElement("a");
        a.href = "#";
        a.textContent = text;
        a.onclick = (e) => { e.preventDefault(); fn(); };
        return a;
      };

      c.appendChild(mk("Pillars", async () => {
        state.selectedPillar = null;
        state.selectedTopic = null;
        state.selectedItem = null;
        el("topics").innerHTML = `<div class="meta">Select a pillar.</div>`;
        el("items").innerHTML = `<div class="meta">Select a topic.</div>`;
        el("previewId").textContent = "—";
        el("previewBody").textContent = "Select an item.";
        await loadPillars();
      }));

      if(state.selectedPillar){
        c.appendChild(mk(state.selectedPillar, async () => {
          state.selectedTopic = null;
          state.selectedItem = null;
          el("items").innerHTML = `<div class="meta">Select a topic.</div>`;
          el("previewId").textContent = "—";
          el("previewBody").textContent = "Select an item.";
          await loadTopics(state.selectedPillar);
        }));
      }
      if(state.selectedTopic){
        c.appendChild(mk(state.selectedTopic, async () => {
          state.selectedItem = null;
          el("previewId").textContent = "—";
          el("previewBody").textContent = "Select an item.";
          await loadItems(state.selectedTopic);
        }));
      }
    }

    function filtered(list){
      const q = el("q").value.trim().toLowerCase();
      if(!q) return list;
      return list.filter(x => JSON.stringify(x).toLowerCase().includes(q));
    }

    function renderList(containerId, list, kind, onClick){
      const container = el(containerId);
      container.innerHTML = "";
      const data = filtered(list);

      if(data.length === 0){
        container.innerHTML = `<div class="meta">No results.</div>`;
        return;
      }

      for(const obj of data){
        const div = document.createElement("div");
        div.className = "item";
        div.onclick = () => onClick(obj);

        div.innerHTML = `
          <div class="title">${label(obj, kind)}</div>
          <div class="meta">${kind === "topic" ? "Pillar: " + obj.pillar : (kind === "item" ? "Topic: " + obj.topic : "")}</div>
        `;
        container.appendChild(div);
      }
    }

    async function apiGet(path){
      const url = `${API_BASE}${path}`;
      const res = await fetch(url, { method: "GET" });
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status} at ${path} :: ${txt}`.slice(0, 500));
      }
      return res.json();
    }

    async function loadPillars(){
      try{
        setStatus("Loading pillars…", "pillars");
        const data = await apiGet("/pillars");
        state.pillars = data;
        el("pillarsCount").textContent = data.length;
        el("topicsCount").textContent = "—";
        el("itemsCount").textContent = "—";

        renderList("pillars", data, "pillar", async (p) => {
          state.selectedPillar = p.id;
          state.selectedTopic = null;
          state.selectedItem = null;
          await loadTopics(p.id);
        });

        setStatus("Ready.", "pillars");
      }catch(err){
        setStatus("Error loading pillars (check console / CORS).", "pillars");
        console.error(err);
        alert(err.message);
      }
    }

    async function loadTopics(pillarId){
      try{
        setStatus(`Loading topics for ${pillarId}…`, "topics");
        const data = await apiGet(`/topics?pillar=${encodeURIComponent(pillarId)}`);
        state.topics = data;
        el("topicsCount").textContent = data.length;
        el("itemsCount").textContent = "—";

        renderList("topics", data, "topic", async (t) => {
          state.selectedTopic = t.id;
          state.selectedItem = null;
          await loadItems(t.id);
        });

        setStatus("Ready.", "topics");
      }catch(err){
        setStatus("Error loading topics.", "topics");
        console.error(err);
        alert(err.message);
      }
    }

    async function loadItems(topicId){
      try{
        setStatus(`Loading items for ${topicId}…`, "items");
        const data = await apiGet(`/items?topic=${encodeURIComponent(topicId)}`);
        state.items = data;
        el("itemsCount").textContent = data.length;

        renderList("items", data, "item", (it) => {
          state.selectedItem = it.id;
          el("previewId").textContent = it.id;

          const lang = el("lang").value;
          const title = (lang === "pt") ? it.title_pt : (lang === "en") ? it.title_en : `${it.title_en} / ${it.title_pt}`;
          const body  = (lang === "pt") ? it.body_pt  : (lang === "en") ? it.body_en  : `${it.body_en}\n\n---\n\n${it.body_pt}`;

          el("previewBody").textContent = `${title}\n\n${body}`;
          setStatus("Ready.", "items");
        });

        setStatus("Ready.", "items");
      }catch(err){
        setStatus("Error loading items.", "items");
        console.error(err);
        alert(err.message);
      }
    }

    async function checkHealth(){
      try{
        setStatus("Checking backend health…");
        const data = await apiGet("/health");
        alert(`Backend health: ${JSON.stringify(data)}`);
        setStatus("Ready.");
      }catch(err){
        console.error(err);
        alert(err.message);
        setStatus("Health check failed.");
      }
    }

    el("refreshBtn").onclick = loadPillars;
    el("healthBtn").onclick = checkHealth;

    el("lang").onchange = () => {
      renderList("pillars", state.pillars, "pillar", async (p) => { state.selectedPillar = p.id; await loadTopics(p.id); });
      if(state.selectedPillar) renderList("topics", state.topics, "topic", async (t) => { state.selectedTopic = t.id; await loadItems(t.id); });
      if(state.selectedTopic) renderList("items", state.items, "item", ()=>{});
      renderCrumb();
    };

    el("q").oninput = () => {
      renderList("pillars", state.pillars, "pillar", async (p) => { state.selectedPillar = p.id; await loadTopics(p.id); });
      if(state.selectedPillar) renderList("topics", state.topics, "topic", async (t) => { state.selectedTopic = t.id; await loadItems(t.id); });
      if(state.selectedTopic) renderList("items", state.items, "item", ()=>{});
    };

    loadPillars();
  </script>
</body>
</html>
